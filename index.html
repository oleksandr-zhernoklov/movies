<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Search</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #007bff;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #movieInput {
            width: calc(100% - 130px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .button {
            padding: 12px 20px;
            font-size: 16px;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
            text-align: center;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button:active {
            background-color: #003d7a;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
            position: sticky;
            top: 0;
        }
        th.sortable.asc::after {
            content: '▲';
        }
        th.sortable.desc::after {
            content: '▼';
        }
        td img.poster {
            width: 50px;
            height: auto;
            border-radius: 5px;
        }
        .links a {
            color: #007bff;
            text-decoration: none;
            margin-right: 10px;
            font-size: 14px;
        }
        .links a:hover {
            text-decoration: underline;
        }
        #removeAllButton {
            float: right;
        }
        #rowCount {
            margin-top: 10px;
            font-weight: bold;
        }
        #summary {
            margin-top: 20px;
        }
        #summary img.poster {
            width: 100px;
            height: auto;
            border-radius: 5px;
        }
        .file-import-export {
            margin: 10px 0;
        }
        .file-import-export input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Movie Search</h1>
        <div>
            <input type="text" id="movieInput" placeholder="Enter movie name...">
            <button class="button" onclick="searchMovie()">Search</button>
            <button class="button" id="removeAllButton" onclick="removeAllMovies()">Remove All</button>
        </div>
        <div class="file-import-export">
            <input type="file" id="importJSON" accept=".json">
            <input type="file" id="importCSV" accept=".csv">
            <button class="button" onclick="exportMovies()">Export JSON</button>
            <button class="button" onclick="exportMoviesCSV()">Export CSV</button>
        </div>
        <div id="summary"></div>
        <table id="movieTable">
            <thead>
                <tr>
                    <th>Row</th>
                    <th>Poster</th>
                    <th onclick="sortTable(2)" class="sortable">Title</th>
                    <th onclick="sortTable(3)" class="sortable">Genre</th>
                    <th onclick="sortTable(4)" class="sortable">Year</th>
                    <th onclick="sortTable(5)" class="sortable">Length</th>
                    <th onclick="sortTable(6)" class="sortable">Rating</th>
                    <th onclick="sortTable(7)" class="sortable">Description</th>
                    <th onclick="sortTable(8)" class="sortable">Director</th>
                    <th onclick="sortTable(9)" class="sortable">Actors</th>
                    <th onclick="sortTable(10)" class="sortable">Review</th>
                    <th>TMDB Link</th>
                    <th>Toloka Link</th>
                    <th>Rutracker Link</th>
                    <th>Trailer</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be dynamically added here -->
            </tbody>
        </table>
        <div id="rowCount">Total Movies: 0</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('#movieInput');

            // Focus on the search input field on page load
            searchInput.focus();

            // Event listener for search input
            searchInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent default action
                    searchMovie(); // Trigger search
                }
            });

            // Handle paste event to put pasted text into the search input
            searchInput.addEventListener('paste', function(event) {
                event.preventDefault();
                const pasteData = (event.clipboardData || window.clipboardData).getData('text');
                searchInput.value = pasteData; // Set the pasted text to the input
                searchMovie(); // Trigger search after pasting
            });

            // Import JSON file
            document.querySelector('#importJSON').addEventListener('change', importMoviesJSON);
            // Import CSV file
            document.querySelector('#importCSV').addEventListener('change', importMoviesCSV);
        });

        async function searchMovie() {
            const movieName = document.querySelector('#movieInput').value.trim();
            if (!movieName) return;

            try {
                const tmdbApiKey = 'fb70d4fb95572e0ddd9bc99f90734e46';
                const response = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(movieName)}`);
                const data = await response.json();

                if (data.results.length > 0) {
                    const movie = data.results[0];
                    const movieId = movie.id;
                    const movieTitle = movie.title;
                    const movieGenreIds = movie.genre_ids;
                    const movieYear = new Date(movie.release_date).getFullYear();
                    const movieLength = movie.runtime ? `${movie.runtime} mins` : 'N/A';
                    const movieDescription = movie.overview || 'N/A';
                    const movieRating = movie.vote_average || 'N/A';
                    const poster = `https://image.tmdb.org/t/p/w200${movie.poster_path}`;
                    const tmdbLink = `https://www.themoviedb.org/movie/${movieId}`;
                    const tolokaLink = `https://toloka.to/tracker.php?nm=${encodeURIComponent(movieTitle)}`;
                    const rutrackerLink = `https://rutracker.org/forum/tracker.php?nm=${encodeURIComponent(movieTitle)}`;
                    const trailer = 'N/A'; // Placeholder as TMDB API doesn't provide trailer link directly

                    // Fetch additional movie details
                    const detailsResponse = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${tmdbApiKey}&append_to_response=credits,reviews`);
                    const detailsData = await detailsResponse.json();
                    const director = detailsData.credits.crew.find(member => member.job === 'Director')?.name || 'N/A';
                    const actors = detailsData.credits.cast.slice(0, 5).map(actor => actor.name).join(', ') || 'N/A';
                    const review = detailsData.reviews.results.length > 0 ? detailsData.reviews.results[0].content : 'N/A';

                    const movieData = {
                        poster,
                        title: movieTitle,
                        genre: getGenreName(movie.genre_ids),
                        year: movieYear,
                        length: movieLength,
                        rating: movieRating,
                        description: movieDescription,
                        director,
                        actors,
                        review,
                        tmdbLink,
                        tolokaLink,
                        rutrackerLink,
                        trailer,
                        id: movieId
                    };

                    if (!isDuplicateMovie(movieId)) {
                        saveMovieToLocalStorage(movieData);
                        displaySummary(movieData);
                        displayMoviesFromLocalStorage();
                    } else {
                        alert('This movie is already in your list.');
                    }
                } else {
                    alert('No movies found with that name.');
                }

                document.querySelector('#movieInput').value = ''; // Clear input after search
            } catch (error) {
                console.error('Error fetching movie data:', error);
            }
        }

        function isDuplicateMovie(movieId) {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            return movies.some(movie => movie.id === movieId);
        }

        function saveMovieToLocalStorage(movieData) {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            movies.push(movieData);
            localStorage.setItem('movies', JSON.stringify(movies));
        }

        function displayMoviesFromLocalStorage() {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const tbody = document.querySelector('#movieTable tbody');
            tbody.innerHTML = '';

            movies.forEach((movie, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><img src="${movie.poster}" class="poster" alt="${movie.title} Poster"></td>
                    <td>${movie.title}</td>
                    <td>${movie.genre}</td>
                    <td>${movie.year}</td>
                    <td>${movie.length}</td>
                    <td>${movie.rating}</td>
                    <td>${movie.description}</td>
                    <td>${movie.director}</td>
                    <td>${movie.actors}</td>
                    <td>${movie.review}</td>
                    <td><a href="${movie.tmdbLink}" target="_blank">TMDB</a></td>
                    <td><a href="${movie.tolokaLink}" target="_blank">Toloka</a></td>
                    <td><a href="${movie.rutrackerLink}" target="_blank">Rutracker</a></td>
                    <td><a href="${movie.trailer}" target="_blank">Trailer</a></td>
                    <td><button class="button" onclick="removeMovie(${movie.id})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });

            document.querySelector('#rowCount').textContent = `Total Movies: ${movies.length}`;
        }

        function removeMovie(movieId) {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const updatedMovies = movies.filter(movie => movie.id !== movieId);
            localStorage.setItem('movies', JSON.stringify(updatedMovies));
            displayMoviesFromLocalStorage();
        }

        function removeAllMovies() {
            if (confirm('Are you sure you want to remove all movies?')) {
                localStorage.removeItem('movies');
                displayMoviesFromLocalStorage();
            }
        }

        function displaySummary(movieData) {
            const summaryDiv = document.querySelector('#summary');
            summaryDiv.innerHTML = `
                <h2>Added Movie</h2>
                <img src="${movieData.poster}" class="poster" alt="${movieData.title} Poster">
                <p><strong>Title:</strong> ${movieData.title}</p>
                <p><strong>Genre:</strong> ${movieData.genre}</p>
                <p><strong>Year:</strong> ${movieData.year}</p>
                <p><strong>Length:</strong> ${movieData.length}</p>
                <p><strong>Rating:</strong> ${movieData.rating}</p>
                <p><strong>Description:</strong> ${movieData.description}</p>
                <p><strong>Director:</strong> ${movieData.director}</p>
                <p><strong>Actors:</strong> ${movieData.actors}</p>
                <p><strong>Review:</strong> ${movieData.review}</p>
                <p><a href="${movieData.tmdbLink}" target="_blank">View on TMDB</a></p>
                <p><a href="${movieData.tolokaLink}" target="_blank">View on Toloka</a></p>
                <p><a href="${movieData.rutrackerLink}" target="_blank">View on Rutracker</a></p>
                <p><a href="${movieData.trailer}" target="_blank">Watch Trailer</a></p>
            `;
        }

        function sortTable(n) {
            const table = document.querySelector('#movieTable');
            let rows, switching, i, x, y, shouldSwitch, dir, switchCount = 0;
            const th = table.querySelector('thead').getElementsByTagName('th');
            const currentTH = th[n];
            switching = true;
            dir = currentTH.classList.contains('asc') ? 'desc' : 'asc';

            while (switching) {
                switching = false;
                rows = table.querySelector('tbody').getElementsByTagName('tr');
                for (i = 0; i < rows.length - 1; i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName('td')[n];
                    y = rows[i + 1].getElementsByTagName('td')[n];
                    if (dir === 'asc' && x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    } else if (dir === 'desc' && x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchCount++;
                } else {
                    if (switchCount === 0 && dir === 'asc') {
                        dir = 'desc';
                        switching = true;
                    }
                }
            }

            Array.from(th).forEach(header => header.classList.remove('asc', 'desc'));
            currentTH.classList.add(dir);
        }

        function exportMovies() {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const blob = new Blob([JSON.stringify(movies, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'movies.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportMoviesCSV() {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            let csv = 'Title,Genre,Year,Length,Rating,Description,Director,Actors,Review,TMDB Link,Toloka Link,Rutracker Link,Trailer\n';
            movies.forEach(movie => {
                csv += `${movie.title},${movie.genre},${movie.year},${movie.length},${movie.rating},${movie.description.replace(/,/g, '')},${movie.director},${movie.actors},${movie.review.replace(/,/g, '')},${movie.tmdbLink},${movie.tolokaLink},${movie.rutrackerLink},${movie.trailer}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'movies.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importMoviesJSON(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const movies = JSON.parse(e.target.result);
                    localStorage.setItem('movies', JSON.stringify(movies));
                    displayMoviesFromLocalStorage();
                } catch (error) {
                    alert('Invalid JSON file.');
                }
            };
            reader.readAsText(file);
        }

        function importMoviesCSV(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const rows = e.target.result.split('\n');
                const movies = [];
                rows.forEach((row, index) => {
                    if (index > 0) {
                        const cols = row.split(',');
                        if (cols.length > 1) {
                            const movieData = {
                                title: cols[0],
                                genre: cols[1],
                                year: cols[2],
                                length: cols[3],
                                rating: cols[4],
                                description: cols[5],
                                director: cols[6],
                                actors: cols[7],
                                review: cols[8],
                                tmdbLink: cols[9],
                                tolokaLink: cols[10],
                                rutrackerLink: cols[11],
                                trailer: cols[12],
                                id: parseInt(cols[13]) // Ensure the ID is an integer
                            };
                            movies.push(movieData);
                        }
                    }
                });
                localStorage.setItem('movies', JSON.stringify(movies));
                displayMoviesFromLocalStorage();
            };
            reader.readAsText(file);
        }

        function getGenreName(genreIds) {
            const genreMapping = {
                28: 'Action',
                12: 'Adventure',
                16: 'Animation',
                35: 'Comedy',
                80: 'Crime',
                99: 'Documentary',
                18: 'Drama',
                10751: 'Family',
                14: 'Fantasy',
                36: 'History',
                27: 'Horror',
                10402: 'Music',
                9648: 'Mystery',
                10749: 'Romance',
                878: 'Science Fiction',
                10770: 'TV Movie',
                53: 'Thriller',
                10752: 'War',
                37: 'Western'
            };
            return genreIds.map(id => genreMapping[id] || 'Unknown').join(', ');
        }

        // Display movies from local storage on page load
        displayMoviesFromLocalStorage();
    </script>
</body>
</html>
