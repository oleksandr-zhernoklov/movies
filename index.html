<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            cursor: pointer;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            margin-top: 10px;
        }
        .poster {
            max-width: 150px;
            max-height: 225px;
            object-fit: cover;
        }
        a {
            color: #1a0dab;
        }
        a:hover {
            text-decoration: underline;
        }
        .file-input {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Movie Search</h1>
    <div class="links">
        <a href="downloaded.html" target="_self">View Downloaded Page</a>
    </div>
    <input type="text" id="movieInput" placeholder="Enter movie name">
    <button onclick="searchMovie()">Search</button>
    <button onclick="removeAllMovies()">Remove All</button>
    <button onclick="exportMovies()">Export Movies</button>
    <label for="importFile" class="button">Import Movies</label>
    <input type="file" id="importFile" class="file-input" accept=".json" onchange="importMovies(event)">

    <h2>Movie Results</h2>
    <div id="summary"></div>
    <table id="movieTable">
        <thead>
            <tr>
                <th>Poster</th>
                <th onclick="sortTable(1)">Title</th>
                <th onclick="sortTable(2)">Genre</th>
                <th onclick="sortTable(3)">Year</th>
                <th onclick="sortTable(4)">Length</th>
                <th onclick="sortTable(5)">Rating</th>
                <th onclick="sortTable(6)">Description</th>
                <th onclick="sortTable(7)">Director</th>
                <th>TMDB Link</th>
                <th>Toloka Link</th>
                <th>Rutracker Link</th>
                <th>Trailer</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Movie results will be added here -->
        </tbody>
    </table>
    <p id="rowCount">Total Movies: 0</p>

    <script>
        const tmdbApiKey = 'fb70d4fb95572e0ddd9bc99f90734e46';
        const genreMapping = {
            28: 'Action',
            12: 'Adventure',
            16: 'Animation',
            35: 'Comedy',
            80: 'Crime',
            99: 'Documentary',
            18: 'Drama',
            10751: 'Family',
            14: 'Fantasy',
            36: 'History',
            27: 'Horror',
            10402: 'Music',
            9648: 'Mystery',
            10749: 'Romance',
            878: 'Science Fiction',
            10770: 'TV Movie',
            53: 'Thriller',
            10752: 'War',
            37: 'Western'
        };

        function getGenreName(genreIds) {
            return genreIds.map(id => genreMapping[id] || 'Unknown').join(', ');
        }

        async function searchMovie() {
            const movieName = document.querySelector('#movieInput').value.trim();
            if (!movieName) {
                alert('Please enter a movie name');
                return;
            }

            const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(movieName)}`;
            try {
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (searchData.results.length > 0) {
                    const movie = searchData.results[0];
                    const movieId = movie.id;
                    const movieTitle = movie.title;
                    const movieGenreIds = movie.genre_ids;
                    const movieYear = new Date(movie.release_date).getFullYear();
                    const moviePosterPath = movie.poster_path ? `https://image.tmdb.org/t/p/w200${movie.poster_path}` : 'https://via.placeholder.com/200x300?text=No+Poster';

                    const detailsUrl = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${tmdbApiKey}`;
                    const detailsResponse = await fetch(detailsUrl);
                    const detailsData = await detailsResponse.json();

                    const movieDescription = detailsData.overview || 'N/A';
                    const movieRating = detailsData.vote_average || 'N/A';
                    const movieLength = detailsData.runtime ? `${detailsData.runtime} mins` : 'N/A';
                    const tmdbLink = `https://www.themoviedb.org/movie/${movieId}`;
                    const tolokaLink = `https://toloka.to/tracker.php?nm=${encodeURIComponent(movieTitle)}`;
                    const rutrackerLink = `https://rutracker.org/forum/tracker.php?nm=${encodeURIComponent(movieTitle)}`;

                    // Fetching the movie credits to get the director
                    const creditsUrl = `https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${tmdbApiKey}`;
                    const creditsResponse = await fetch(creditsUrl);
                    const creditsData = await creditsResponse.json();
                    const director = creditsData.crew.find(person => person.job === 'Director')?.name || 'N/A';

                    // Fetching the movie videos to get the trailer
                    const videosUrl = `https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${tmdbApiKey}`;
                    const videosResponse = await fetch(videosUrl);
                    const videosData = await videosResponse.json();
                    const trailer = videosData.results.find(video => video.type === 'Trailer');
                    const trailerLink = trailer ? `https://www.youtube.com/watch?v=${trailer.key}` : 'N/A';

                    const movieData = {
                        poster: moviePosterPath,
                        title: movieTitle,
                        genre: getGenreName(movieGenreIds),
                        year: movieYear,
                        length: movieLength,
                        rating: movieRating,
                        description: movieDescription,
                        director: director,
                        tmdbLink: tmdbLink,
                        tolokaLink: tolokaLink,
                        rutrackerLink: rutrackerLink,
                        trailer: trailerLink,
                        id: movieId
                    };

                    if (!isDuplicateMovie(movieId)) {
                        saveMovieToLocalStorage(movieData);
                        displayMoviesFromLocalStorage();
                        displaySummary(movieData);
                    } else {
                        alert('Movie already exists in the list.');
                    }
                } else {
                    alert('No movie found');
                }
            } catch (error) {
                alert('Failed to retrieve movie information');
                console.error('Error:', error);
            }
        }

        function isDuplicateMovie(movieId) {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            return movies.some(movie => movie.id === parseInt(movieId));
        }

        function saveMovieToLocalStorage(movieData) {
            let movies = JSON.parse(localStorage.getItem('movies')) || [];
            movies.push(movieData);
            localStorage.setItem('movies', JSON.stringify(movies));
        }

        function displayMoviesFromLocalStorage() {
            const tbody = document.querySelector('#movieTable tbody');
            tbody.innerHTML = ''; // Clear previous results

            let movies = JSON.parse(localStorage.getItem('movies')) || [];
            movies.forEach(movie => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${movie.poster}" alt="${movie.title} Poster" class="poster"></td>
                    <td>${movie.title}</td>
                    <td>${movie.genre}</td>
                    <td>${movie.year}</td>
                    <td>${movie.length}</td>
                    <td>${movie.rating}</td>
                    <td>${movie.description}</td>
                    <td>${movie.director}</td>
                    <td><a href="${movie.tmdbLink}" target="_blank">${movie.tmdbLink}</a></td>
                    <td><a href="${movie.tolokaLink}" target="_blank">${movie.tolokaLink}</a></td>
                    <td><a href="${movie.rutrackerLink}" target="_blank">${movie.rutrackerLink}</a></td>
                    <td><a href="${movie.trailer}" target="_blank">${movie.trailer}</a></td>
                    <td><button onclick="removeMovie('${movie.id}')">Remove</button></td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('rowCount').innerText = `Total Movies: ${movies.length}`;
        }

        function displaySummary(movieData) {
            const summary = document.querySelector('#summary');
            summary.innerHTML = `
                <h3>Last Added Movie</h3>
                <img src="${movieData.poster}" alt="${movieData.title} Poster" class="poster">
                <p>Title: ${movieData.title}</p>
                <p>Genre: ${movieData.genre}</p>
                <p>Year: ${movieData.year}</p>
                <p>Length: ${movieData.length}</p>
                <p>Rating: ${movieData.rating}</p>
                <p>Description: ${movieData.description}</p>
                <p>Director: ${movieData.director}</p>
                <p>TMDB Link: <a href="${movieData.tmdbLink}" target="_blank">${movieData.tmdbLink}</a></p>
                <p>Toloka Link: <a href="${movieData.tolokaLink}" target="_blank">${movieData.tolokaLink}</a></p>
                <p>Rutracker Link: <a href="${movieData.rutrackerLink}" target="_blank">${movieData.rutrackerLink}</a></p>
                <p>Trailer: <a href="${movieData.trailer}" target="_blank">${movieData.trailer}</a></p>
            `;
        }

        function removeMovie(movieId) {
            let movies = JSON.parse(localStorage.getItem('movies')) || [];
            movies = movies.filter(movie => movie.id !== parseInt(movieId));
            localStorage.setItem('movies', JSON.stringify(movies));
            displayMoviesFromLocalStorage();
        }

        function removeAllMovies() {
            localStorage.removeItem('movies');
            displayMoviesFromLocalStorage();
        }

        function sortTable(columnIndex) {
            const table = document.querySelector('#movieTable');
            const rows = Array.from(table.querySelectorAll('tbody > tr'));
            const isAscending = table.querySelectorAll('th')[columnIndex].classList.contains('asc');

            rows.sort((rowA, rowB) => {
                const cellA = rowA.children[columnIndex].innerText.trim();
                const cellB = rowB.children[columnIndex].innerText.trim();
                return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });

            table.querySelector('tbody').append(...rows);
            table.querySelectorAll('th').forEach(th => th.classList.remove('asc', 'desc'));
            table.querySelectorAll('th')[columnIndex].classList.add(isAscending ? 'desc' : 'asc');
        }

        function exportMovies() {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const blob = new Blob([JSON.stringify(movies, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'movies.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importMovies(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const importedMovies = JSON.parse(e.target.result);
                    let existingMovies = JSON.parse(localStorage.getItem('movies')) || [];

                    importedMovies.forEach(importedMovie => {
                        if (!existingMovies.some(movie => movie.id === importedMovie.id)) {
                            existingMovies.push(importedMovie);
                        }
                    });

                    localStorage.setItem('movies', JSON.stringify(existingMovies));
                    displayMoviesFromLocalStorage();
                };
                reader.readAsText(file);
            }
        }

        // Display movies from localStorage when the page loads
        displayMoviesFromLocalStorage();
    </script>
</body>
</html>
