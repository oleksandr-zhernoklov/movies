<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie List Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #333;
            color: #fff;
            padding: 1rem;
            text-align: center;
        }
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 2rem auto;
            overflow-x: hidden;
        }
        input[type="text"] {
            width: calc(100% - 150px);
            padding: 0.5rem;
            margin-right: 10px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-sizing: border-box;
        }
        button:hover {
            background-color: #555;
        }
        button.remove-all {
            background-color: #e74c3c;
        }
        button.remove-all:hover {
            background-color: #c0392b;
        }
        .summary, .import-export {
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
        }
        .summary input[type="text"] {
            flex: 1;
        }
        .import-export {
            margin-bottom: 2rem;
            gap: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            overflow-x: auto;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #333;
            color: #fff;
        }
        .poster {
            width: 80px;
            height: auto;
        }
        .import-export input[type="file"] {
            margin-right: 10px;
        }
        .import-export label {
            margin-right: 10px;
        }
        #rowCount {
            margin: 1rem 0;
            font-size: 1rem;
        }
        .table-container {
            overflow-x: auto;
        }
        .button {
            padding: 0.5rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Movie List Manager</h1>
    </header>
    <div class="container">
        <div class="import-export">
            <label for="importJSON">Import JSON:</label>
            <input type="file" id="importJSON" accept=".json">
            <label for="importCSV">Import CSV:</label>
            <input type="file" id="importCSV" accept=".csv">
            <button onclick="exportMovies()">Export JSON</button>
            <button onclick="exportMoviesCSV()">Export CSV</button>
        </div>
        <div class="summary">
            <input type="text" id="movieInput" placeholder="Search for a movie...">
            <button onclick="searchMovie()">Search</button>
            <button class="remove-all" onclick="removeAllMovies()">Remove All</button>
        </div>
        <div id="summary"></div>
        <div id="rowCount"></div>
        <div class="table-container">
            <table id="movieTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Poster</th>
                        <th>Title</th>
                        <th>Genre</th>
                        <th>Year</th>
                        <th>Length</th>
                        <th>Rating</th>
                        <th>Description</th>
                        <th>Director</th>
                        <th>Actors</th>
                        <th>Review</th>
                        <th>TMDB</th>
                        <th>IMDb</th>
                        <th>Toloka</th>
                        <th>Rutracker</th>
                        <th>Trailer</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Movie rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('#movieInput').focus();

            document.querySelector('#importJSON').addEventListener('change', importMoviesJSON);
            document.querySelector('#importCSV').addEventListener('change', importMoviesCSV);

            // Handle paste event to input field
            document.querySelector('#movieInput').addEventListener('paste', (event) => {
                setTimeout(() => {
                    searchMovie();
                }, 100);
            });

            displayMoviesFromLocalStorage(); // Load existing movies on page load
        });

        function searchMovie() {
            let movieName = document.querySelector('#movieInput').value.trim();
            movieName = movieName.replace(/^\.+/, ''); // Remove leading dots

            if (!movieName) return;

            fetchMovieData(movieName);
        }

        async function fetchMovieData(movieName) {
            const apiKey = 'fb70d4fb95572e0ddd9bc99f90734e46';
            try {
                const response = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${movieName}`);
                const data = await response.json();
                if (data.results.length > 0) {
                    const movie = data.results[0];
                    const movieId = movie.id;
                    const movieDetailsResponse = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${apiKey}`);
                    const movieDetails = await movieDetailsResponse.json();

                    const movieData = {
                        title: movie.title,
                        genre: getGenreName(movie.genre_ids),
                        year: new Date(movie.release_date).getFullYear(),
                        length: movieDetails.runtime ? `${movieDetails.runtime} mins` : 'N/A',
                        rating: movieDetails.vote_average,
                        description: movieDetails.overview,
                        director: movieDetails.credits.crew.find(person => person.job === 'Director')?.name || 'N/A',
                        actors: movieDetails.credits.cast.map(actor => actor.name).join(', '),
                        review: movieDetails.reviews.results[0]?.content || 'N/A',
                        tmdbLink: `https://www.themoviedb.org/movie/${movieId}`,
                        imdbLink: movieDetails.imdb_id ? `https://www.imdb.com/title/${movieDetails.imdb_id}` : 'N/A',
                        tolokaLink: `https://toloka.to/tracker.php?nm=${movie.title}`,
                        rutrackerLink: `https://rutracker.org/forum/tracker.php?nm=${movie.title}`,
                        trailer: movieDetails.videos.results.length > 0 ? `https://www.youtube.com/watch?v=${movieDetails.videos.results[0].key}` : 'N/A',
                        poster: `https://image.tmdb.org/t/p/w200${movie.poster_path}`,
                        id: movieId
                    };

                    if (!isDuplicateMovie(movieData.id)) {
                        saveMovieToLocalStorage(movieData);
                        displayMoviesFromLocalStorage();
                        displaySummary(movieData);
                    } else {
                        alert('This movie is already in your list.');
                    }
                } else {
                    alert('No movies found with that name.');
                }

                document.querySelector('#movieInput').value = ''; // Clear input after search
            } catch (error) {
                console.error('Error fetching movie data:', error);
            }
        }

        function getGenreName(genreIds) {
            const genreMap = {
                28: 'Action',
                12: 'Adventure',
                16: 'Animation',
                35: 'Comedy',
                80: 'Crime',
                99: 'Documentary',
                18: 'Drama',
                10751: 'Family',
                14: 'Fantasy',
                36: 'History',
                27: 'Horror',
                10402: 'Music',
                9648: 'Mystery',
                10749: 'Romance',
                878: 'Science Fiction',
                10770: 'TV Movie',
                53: 'Thriller',
                10752: 'War',
                37: 'Western'
            };
            return genreIds.map(id => genreMap[id] || 'Unknown').join(', ');
        }

        function isDuplicateMovie(movieId) {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            return movies.some(movie => movie.id === movieId);
        }

        function saveMovieToLocalStorage(movieData) {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            movies.push(movieData);
            localStorage.setItem('movies', JSON.stringify(movies));
        }

        function displayMoviesFromLocalStorage() {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const tbody = document.querySelector('#movieTable tbody');
            tbody.innerHTML = '';

            movies.forEach((movie, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><img src="${movie.poster}" class="poster" alt="${movie.title} poster"></td>
                    <td>${movie.title}</td>
                    <td>${movie.genre}</td>
                    <td>${movie.year}</td>
                    <td>${movie.length}</td>
                    <td>${movie.rating}</td>
                    <td>${movie.description}</td>
                    <td>${movie.director}</td>
                    <td>${movie.actors}</td>
                    <td>${movie.review}</td>
                    <td><a href="${movie.tmdbLink}" target="_blank">TMDB</a></td>
                    <td><a href="${movie.imdbLink}" target="_blank">IMDb</a></td>
                    <td><a href="${movie.tolokaLink}" target="_blank">Toloka</a></td>
                    <td><a href="${movie.rutrackerLink}" target="_blank">Rutracker</a></td>
                    <td><a href="${movie.trailer}" target="_blank">Trailer</a></td>
                    <td><button class="button" onclick="removeMovie(${movie.id})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });

            document.querySelector('#rowCount').textContent = `Total Movies: ${movies.length}`;
        }

        function removeMovie(movieId) {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const updatedMovies = movies.filter(movie => movie.id !== movieId);
            localStorage.setItem('movies', JSON.stringify(updatedMovies));
            displayMoviesFromLocalStorage();
        }

        function removeAllMovies() {
            if (confirm('Are you sure you want to remove all movies?')) {
                localStorage.removeItem('movies');
                displayMoviesFromLocalStorage();
            }
        }

        function displaySummary(movieData) {
            const summaryDiv = document.querySelector('#summary');
            summaryDiv.innerHTML = `
                <h2>Added Movie</h2>
                <p><strong>Title:</strong> ${movieData.title}</p>
                <p><strong>Genre:</strong> ${movieData.genre}</p>
                <p><strong>Year:</strong> ${movieData.year}</p>
                <p><strong>Length:</strong> ${movieData.length}</p>
                <p><strong>Rating:</strong> ${movieData.rating}</p>
                <p><strong>Description:</strong> ${movieData.description}</p>
                <p><strong>Director:</strong> ${movieData.director}</p>
                <p><strong>Actors:</strong> ${movieData.actors}</p>
                <p><strong>Review:</strong> ${movieData.review}</p>
                <p><strong>TMDB Link:</strong> <a href="${movieData.tmdbLink}" target="_blank">${movieData.tmdbLink}</a></p>
                <p><strong>IMDb Link:</strong> <a href="${movieData.imdbLink}" target="_blank">${movieData.imdbLink}</a></p>
                <p><strong>Toloka Link:</strong> <a href="${movieData.tolokaLink}" target="_blank">${movieData.tolokaLink}</a></p>
                <p><strong>Rutracker Link:</strong> <a href="${movieData.rutrackerLink}" target="_blank">${movieData.rutrackerLink}</a></p>
                <p><strong>Trailer Link:</strong> <a href="${movieData.trailer}" target="_blank">${movieData.trailer}</a></p>
            `;
        }

        function exportMovies() {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const dataStr = JSON.stringify(movies, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'movies.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportMoviesCSV() {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const header = [
                'Title', 'Genre', 'Year', 'Length', 'Rating', 'Description', 'Director', 'Actors', 'Review', 'TMDB Link', 'IMDb Link', 'Toloka Link', 'Rutracker Link', 'Trailer Link'
            ];
            const rows = movies.map(movie => [
                movie.title, movie.genre, movie.year, movie.length, movie.rating, movie.description, movie.director, movie.actors, movie.review, movie.tmdbLink, movie.imdbLink, movie.tolokaLink, movie.rutrackerLink, movie.trailer
            ]);
            let csvContent = 'data:text/csv;charset=utf-8,' + [header, ...rows].map(e => e.join(',')).join('\n');
            const encodedUri = encodeURI(csvContent);
            const a = document.createElement('a');
            a.href = encodedUri;
            a.download = 'movies.csv';
            a.click();
        }

        function importMoviesJSON(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = () => {
                    const movies = JSON.parse(reader.result);
                    // Ensure all movies have the new attributes
                    const updatedMovies = movies.map(movie => ({
                        title: movie.title || '',
                        genre: movie.genre || '',
                        year: movie.year || '',
                        length: movie.length || '',
                        rating: movie.rating || '',
                        description: movie.description || '',
                        director: movie.director || '',
                        actors: movie.actors || '',
                        review: movie.review || '',
                        tmdbLink: movie.tmdbLink || '',
                        imdbLink: movie.imdbLink || '',
                        tolokaLink: movie.tolokaLink || '',
                        rutrackerLink: movie.rutrackerLink || '',
                        trailer: movie.trailer || '',
                        poster: movie.poster || '',
                        id: movie.id || null
                    }));
                    localStorage.setItem('movies', JSON.stringify(updatedMovies));
                    displayMoviesFromLocalStorage();
                };
                reader.readAsText(file);
            } else {
                alert('Please upload a valid JSON file.');
            }
        }

        function importMoviesCSV(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                const reader = new FileReader();
                reader.onload = () => {
                    const rows = reader.result.split('\n').map(row => row.split(','));
                    const header = rows.shift();
                    const movies = rows.map(row => ({
                        title: row[0] || '',
                        genre: row[1] || '',
                        year: row[2] || '',
                        length: row[3] || '',
                        rating: row[4] || '',
                        description: row[5] || '',
                        director: row[6] || '',
                        actors: row[7] || '',
                        review: row[8] || '',
                        tmdbLink: row[9] || '',
                        imdbLink: row[10] || '',
                        tolokaLink: row[11] || '',
                        rutrackerLink: row[12] || '',
                        trailer: row[13] || '',
                        poster: '', // CSV does not include poster URLs
                        id: parseInt(row[9].match(/movie\/(\d+)/)?.[1] || null) // Extract TMDB ID from URL
                    }));
                    localStorage.setItem('movies', JSON.stringify(movies));
                    displayMoviesFromLocalStorage();
                };
                reader.readAsText(file);
            } else {
                alert('Please upload a valid CSV file.');
            }
        }
    </script>
</body>
</html>
