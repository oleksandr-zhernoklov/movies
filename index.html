<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            cursor: pointer;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            margin-top: 10px;
        }
        .poster {
            max-width: 150px;
            max-height: 225px;
            object-fit: cover;
        }
        a {
            color: #1a0dab;
        }
        a:hover {
            text-decoration: underline;
        }
        .file-input {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Movie Search</h1>
    <div class="links">
        <a href="downloaded.html" target="_self">View Downloaded Page</a>
    </div>
    <input type="text" id="movieInput" placeholder="Enter movie name">
    <button onclick="searchMovie()">Search</button>
    <button onclick="removeAllMovies()">Remove All</button>
    <button onclick="exportMoviesJSON()">Export Movies (JSON)</button>
    <button onclick="exportMoviesCSV()">Export Movies (CSV)</button>
    <label for="importFileJSON" class="button">Import Movies (JSON)</label>
    <input type="file" id="importFileJSON" class="file-input" accept=".json" onchange="importMoviesJSON(event)">
    <label for="importFileCSV" class="button">Import Movies (CSV)</label>
    <input type="file" id="importFileCSV" class="file-input" accept=".csv" onchange="importMoviesCSV(event)">

    <h2>Movie Results</h2>
    <div id="summary"></div>
    <table id="movieTable">
        <thead>
            <tr>
                <th>Poster</th>
                <th onclick="sortTable(1)">Title</th>
                <th onclick="sortTable(2)">Genre</th>
                <th onclick="sortTable(3)">Year</th>
                <th onclick="sortTable(4)">Length</th>
                <th onclick="sortTable(5)">Rating</th>
                <th onclick="sortTable(6)">Description</th>
                <th onclick="sortTable(7)">Director</th>
                <th>TMDB Link</th>
                <th>Toloka Link</th>
                <th>Rutracker Link</th>
                <th>Trailer</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Movie results will be added here -->
        </tbody>
    </table>
    <p id="rowCount">Total Movies: 0</p>

    <script>
        const tmdbApiKey = 'fb70d4fb95572e0ddd9bc99f90734e46';
        const genreMapping = {
            28: 'Action',
            12: 'Adventure',
            16: 'Animation',
            35: 'Comedy',
            80: 'Crime',
            99: 'Documentary',
            18: 'Drama',
            10751: 'Family',
            14: 'Fantasy',
            36: 'History',
            27: 'Horror',
            10402: 'Music',
            9648: 'Mystery',
            10749: 'Romance',
            878: 'Science Fiction',
            10770: 'TV Movie',
            53: 'Thriller',
            10752: 'War',
            37: 'Western'
        };

        function getGenreName(genreIds) {
            return genreIds.map(id => genreMapping[id] || 'Unknown').join(', ');
        }

        async function searchMovie() {
            const movieName = document.querySelector('#movieInput').value.trim();
            if (!movieName) {
                alert('Please enter a movie name');
                return;
            }

            const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(movieName)}`;
            try {
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (searchData.results.length > 0) {
                    const movie = searchData.results[0];
                    const movieId = movie.id;
                    const movieTitle = movie.title;
                    const movieGenreIds = movie.genre_ids;
                    const movieYear = new Date(movie.release_date).getFullYear();
                    const moviePosterPath = movie.poster_path ? `https://image.tmdb.org/t/p/w200${movie.poster_path}` : 'https://via.placeholder.com/200x300?text=No+Poster';

                    const detailsUrl = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${tmdbApiKey}`;
                    const detailsResponse = await fetch(detailsUrl);
                    const detailsData = await detailsResponse.json();

                    const movieDescription = detailsData.overview || 'N/A';
                    const movieRating = detailsData.vote_average || 'N/A';
                    const movieLength = detailsData.runtime ? `${detailsData.runtime} mins` : 'N/A';
                    const tmdbLink = `https://www.themoviedb.org/movie/${movieId}`;
                    const tolokaLink = `https://toloka.to/tracker.php?nm=${encodeURIComponent(movieTitle)}`;
                    const rutrackerLink = `https://rutracker.org/forum/tracker.php?nm=${encodeURIComponent(movieTitle)}`;

                    // Fetching the movie credits to get the director
                    const creditsUrl = `https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${tmdbApiKey}`;
                    const creditsResponse = await fetch(creditsUrl);
                    const creditsData = await creditsResponse.json();
                    const director = creditsData.crew.find(person => person.job === 'Director')?.name || 'N/A';

                    // Fetching the movie videos to get the trailer
                    const videosUrl = `https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${tmdbApiKey}`;
                    const videosResponse = await fetch(videosUrl);
                    const videosData = await videosResponse.json();
                    const trailer = videosData.results.find(video => video.type === 'Trailer');
                    const trailerLink = trailer ? `https://www.youtube.com/watch?v=${trailer.key}` : 'N/A';

                    const movieData = {
                        poster: moviePosterPath,
                        title: movieTitle,
                        genre: getGenreName(movieGenreIds),
                        year: movieYear,
                        length: movieLength,
                        rating: movieRating,
                        description: movieDescription,
                        director: director,
                        tmdbLink: tmdbLink,
                        tolokaLink: tolokaLink,
                        rutrackerLink: rutrackerLink,
                        trailer: trailerLink,
                        id: movieId
                    };

                    if (!isDuplicateMovie(movieId)) {
                        saveMovieToLocalStorage(movieData);
                        displayMoviesFromLocalStorage();
                        displaySummary(movieData);
                    } else {
                        alert('Movie already exists in the list.');
                    }
                } else {
                    alert('No movie found');
                }
            } catch (error) {
                alert('Failed to retrieve movie information');
                console.error
