<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            cursor: pointer;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            margin-top: 10px;
        }
        .poster {
            max-width: 150px;
            max-height: 225px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <h1>Movie Search</h1>
    <div class="links">
        <a href="downloaded.html" target="_self">View Downloaded Page</a>
    </div>
    <input type="text" id="movieInput" placeholder="Enter movie name">
    <button onclick="searchMovie()">Search</button>
    <button onclick="removeAllMovies()">Remove All</button>

    <h2>Movie Results</h2>
    <table id="movieTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Poster</th>
                <th onclick="sortTable(1)">Title</th>
                <th onclick="sortTable(2)">Genre</th>
                <th onclick="sortTable(3)">Year</th>
                <th onclick="sortTable(4)">Length</th>
                <th onclick="sortTable(5)">Rating</th>
                <th onclick="sortTable(6)">Description</th>
                <th onclick="sortTable(7)">Director</th>
                <th>TMDB Link</th>
                <th>Toloka Link</th>
                <th>Rutracker Link</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Movie results will be added here -->
        </tbody>
    </table>

    <script>
        const tmdbApiKey = 'fb70d4fb95572e0ddd9bc99f90734e46';
        const genreMapping = {
            28: 'Action',
            12: 'Adventure',
            16: 'Animation',
            35: 'Comedy',
            80: 'Crime',
            99: 'Documentary',
            18: 'Drama',
            10751: 'Family',
            14: 'Fantasy',
            36: 'History',
            27: 'Horror',
            10402: 'Music',
            9648: 'Mystery',
            10749: 'Romance',
            878: 'Science Fiction',
            10770: 'TV Movie',
            53: 'Thriller',
            10752: 'War',
            37: 'Western'
        };

        function getGenreName(genreIds) {
            return genreIds.map(id => genreMapping[id] || 'Unknown').join(', ');
        }

        async function searchMovie() {
            const movieName = document.querySelector('#movieInput').value.trim();
            if (!movieName) {
                alert('Please enter a movie name');
                return;
            }

            const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(movieName)}`;
            try {
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (searchData.results.length > 0) {
                    const movie = searchData.results[0];
                    const movieId = movie.id;
                    const movieTitle = movie.title;
                    const movieGenreIds = movie.genre_ids;
                    const movieYear = new Date(movie.release_date).getFullYear();
                    const moviePosterPath = movie.poster_path ? `https://image.tmdb.org/t/p/w200${movie.poster_path}` : 'https://via.placeholder.com/200x300?text=No+Poster';

                    const detailsUrl = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${tmdbApiKey}`;
                    const detailsResponse = await fetch(detailsUrl);
                    const detailsData = await detailsResponse.json();

                    const movieDescription = detailsData.overview || 'N/A';
                    const movieRating = detailsData.vote_average || 'N/A';
                    const movieLength = detailsData.runtime ? `${detailsData.runtime} mins` : 'N/A';
                    const tmdbLink = `https://www.themoviedb.org/movie/${movieId}`;
                    const tolokaLink = `https://toloka.to/tracker.php?nm=${encodeURIComponent(movieTitle)}`;
                    const rutrackerLink = `https://rutracker.org/forum/tracker.php?nm=${encodeURIComponent(movieTitle)}`;

                    // Fetching the movie credits to get the director
                    const creditsUrl = `https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${tmdbApiKey}`;
                    const creditsResponse = await fetch(creditsUrl);
                    const creditsData = await creditsResponse.json();
                    const director = creditsData.crew.find(person => person.job === 'Director')?.name || 'N/A';

                    const movieData = {
                        poster: moviePosterPath,
                        title: movieTitle,
                        genre: getGenreName(movieGenreIds),
                        year: movieYear,
                        length: movieLength,
                        rating: movieRating,
                        description: movieDescription,
                        director: director,
                        tmdbLink: tmdbLink,
                        tolokaLink: tolokaLink,
                        rutrackerLink: rutrackerLink,
                        id: movieId
                    };

                    if (!isDuplicateMovie(movieId)) {
                        saveMovieToLocalStorage(movieData);
                        displayMoviesFromLocalStorage();
                    } else {
                        alert('Movie already exists in the list.');
                    }
                } else {
                    alert('No movie found');
                }
            } catch (error) {
                alert('Failed to retrieve movie information');
                console.error('Error:', error);
            }
        }

        function isDuplicateMovie(movieId) {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            return movies.some(movie => movie.id === movieId);
        }

        function saveMovieToLocalStorage(movieData) {
            let movies = JSON.parse(localStorage.getItem('movies')) || [];
            movies.push(movieData);
            localStorage.setItem('movies', JSON.stringify(movies));
        }

        function displayMoviesFromLocalStorage() {
            const tbody = document.querySelector('#movieTable tbody');
            tbody.innerHTML = ''; // Clear previous results

            let movies = JSON.parse(localStorage.getItem('movies')) || [];
            movies.forEach(movie => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${movie.poster}" alt="${movie.title} Poster" class="poster"></td>
                    <td>${movie.title}</td>
                    <td>${movie.genre}</td>
                    <td>${movie.year}</td>
                    <td>${movie.length}</td>
                    <td>${movie.rating}</td>
                    <td>${movie.description}</td>
                    <td>${movie.director}</td>
                    <td><a href="${movie.tmdbLink}" target="_blank">${movie.tmdbLink}</a></td>
                    <td><a href="${movie.tolokaLink}" target="_blank">${movie.tolokaLink}</a></td>
                    <td><a href="${movie.rutrackerLink}" target="_blank">${movie.rutrackerLink}</a></td>
                    <td><button onclick="removeMovie('${movie.id}')">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function removeMovie(movieId) {
            console.log(`Removing movie with ID: ${movieId}`);
            let movies = JSON.parse(localStorage.getItem('movies')) || [];
            console.log('Movies before removal:', JSON.stringify(movies));

            movies = movies.filter(movie => movie.id !== parseInt(movieId));
            console.log('Movies after removal:', JSON.stringify(movies));

            localStorage.setItem('movies', JSON.stringify(movies));
            displayMoviesFromLocalStorage();
        }


        function removeAllMovies() {
            localStorage.removeItem('movies');
            displayMoviesFromLocalStorage();
        }

        function sortTable(columnIndex) {
            const table = document.querySelector('#movieTable');
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const isAscending = table.querySelectorAll('th')[columnIndex].classList.contains('asc');
            rows.sort((rowA, rowB) => {
                const cellA = rowA.children[columnIndex].textContent.trim();
                const cellB = rowB.children[columnIndex].textContent.trim();

                if (!isNaN(cellA) && !isNaN(cellB)) {
                    return isAscending ? cellA - cellB : cellB - cellA;
                }
                return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });

            table.querySelector('tbody').append(...rows);
            table.querySelectorAll('th').forEach(th => th.classList.remove('asc', 'desc'));
            table.querySelectorAll('th')[columnIndex].classList.add(isAscending ? 'desc' : 'asc');
        }

        // Display movies from localStorage when the page loads
        displayMoviesFromLocalStorage();
    </script>
</body>
</html>
