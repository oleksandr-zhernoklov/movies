<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
            color: #343a40;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: #ffffff;
            cursor: pointer;
        }
        th:hover {
            background-color: #0056b3;
        }
        button, label.button {
            margin: 5px;
            padding: 8px 15px;
            font-size: 14px;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover, label.button:hover {
            background-color: #0056b3;
        }
        .links a {
            color: #007bff;
            text-decoration: none;
            margin-right: 15px;
        }
        .links a:hover {
            text-decoration: underline;
        }
        .poster {
            max-width: 100px;
            max-height: 150px;
            object-fit: cover;
        }
        .file-input {
            display: none;
        }
        #summary img {
            max-width: 150px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Movie Search</h1>
    <div class="links">
        <a href="downloaded.html" target="_self">View Downloaded Page</a>
    </div>
    <input type="text" id="movieInput" placeholder="Enter movie name">
    <button id="searchButton" onclick="searchMovie()">Search</button>
    <button onclick="exportMovies()">Export Movies (JSON)</button>
    <button onclick="exportMoviesCSV()">Export Movies (CSV)</button>
    <label for="importFileJSON" class="button">Import Movies (JSON)</label>
    <input type="file" id="importFileJSON" class="file-input" accept=".json" onchange="importMoviesJSON(event)">
    <label for="importFileCSV" class="button">Import Movies (CSV)</label>
    <input type="file" id="importFileCSV" class="file-input" accept=".csv" onchange="importMoviesCSV(event)">
    <button onclick="removeAllMovies()" style="float: right;">Remove All</button>

    <h2>Movie Results</h2>
    <div id="summary"></div>
    <table id="movieTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Poster</th>
                <th onclick="sortTable(2)">Title</th>
                <th onclick="sortTable(3)">Genre</th>
                <th onclick="sortTable(4)">Year</th>
                <th onclick="sortTable(5)">Length</th>
                <th onclick="sortTable(6)">Rating</th>
                <th onclick="sortTable(7)">Description</th>
                <th onclick="sortTable(8)">Director</th>
                <th onclick="sortTable(9)">Actors</th>
                <th onclick="sortTable(10)">Review</th>
                <th>TMDB Link</th>
                <th>Toloka Link</th>
                <th>Rutracker Link</th>
                <th>Trailer</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Movie results will be added here -->
        </tbody>
    </table>
    <p id="rowCount">Total Movies: 0</p>

    <script>
        const tmdbApiKey = 'fb70d4fb95572e0ddd9bc99f90734e46';
        const genreMapping = {
            28: 'Action',
            12: 'Adventure',
            16: 'Animation',
            35: 'Comedy',
            80: 'Crime',
            99: 'Documentary',
            18: 'Drama',
            10751: 'Family',
            14: 'Fantasy',
            36: 'History',
            27: 'Horror',
            10402: 'Music',
            9648: 'Mystery',
            10749: 'Romance',
            878: 'Science Fiction',
            10770: 'TV Movie',
            53: 'Thriller',
            10752: 'War',
            37: 'Western'
        };
        document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('#movieInput');

    // Focus on the search input field on page load
    searchInput.focus();

    // Event listener for search input
    searchInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent default action
            searchMovie(); // Trigger search
        }
    });

    // Handle paste event to put pasted text into the search input
    searchInput.addEventListener('paste', function(event) {
        event.preventDefault();
        const pasteData = (event.clipboardData || window.clipboardData).getData('text');
        searchInput.value = pasteData; // Set the pasted text to the input
        searchMovie(); // Trigger search after pasting
    });
});


        function getGenreName(genreIds) {
            return genreIds.map(id => genreMapping[id] || 'Unknown').join(', ');
        }

        async function searchMovie() {
            const movieName = document.querySelector('#movieInput').value.trim();
            if (!movieName) {
                alert('Please enter a movie name');
                return;
            }

            const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(movieName)}`;
            try {
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (searchData.results.length > 0) {
                    const movie = searchData.results[0];
                    const movieId = movie.id;
                    const movieTitle = movie.title;
                    const movieGenreIds = movie.genre_ids;
                    const movieYear = new Date(movie.release_date).getFullYear();
                    const moviePosterPath = movie.poster_path ? `https://image.tmdb.org/t/p/w200${movie.poster_path}` : 'https://via.placeholder.com/200x300?text=No+Poster';

                    const detailsUrl = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${tmdbApiKey}`;
                    const detailsResponse = await fetch(detailsUrl);
                    const detailsData = await detailsResponse.json();

                    const movieDescription = detailsData.overview || 'N/A';
                    const movieRating = detailsData.vote_average || 'N/A';
                    const movieLength = detailsData.runtime ? `${detailsData.runtime} mins` : 'N/A';
                    const tmdbLink = `https://www.themoviedb.org/movie/${movieId}`;
                    const tolokaLink = `https://toloka.to/tracker.php?nm=${encodeURIComponent(movieTitle)}`;
                    const rutrackerLink = `https://rutracker.org/forum/tracker.php?nm=${encodeURIComponent(movieTitle)}`;

                    // Fetching the movie credits to get the director and actors
                    const creditsUrl = `https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${tmdbApiKey}`;
                    const creditsResponse = await fetch(creditsUrl);
                    const creditsData = await creditsResponse.json();
                    const director = creditsData.crew.find(person => person.job === 'Director')?.name || 'N/A';
                    const actors = creditsData.cast.slice(0, 5).map(actor => actor.name).join(', ') || 'N/A';

                    // Fetching the movie reviews to get one review
                    const reviewsUrl = `https://api.themoviedb.org/3/movie/${movieId}/reviews?api_key=${tmdbApiKey}`;
                    const reviewsResponse = await fetch(reviewsUrl);
                    const reviewsData = await reviewsResponse.json();
                    const review = reviewsData.results.length > 0 ? reviewsData.results[0].content : 'N/A';

                    // Fetching the movie videos to get the trailer
                    const videosUrl = `https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${tmdbApiKey}`;
                    const videosResponse = await fetch(videosUrl);
                    const videosData = await videosResponse.json();
                    const trailer = videosData.results.find(video => video.type === 'Trailer');
                    const trailerLink = trailer ? `https://www.youtube.com/watch?v=${trailer.key}` : 'N/A';

                    const movieData = {
                        poster: moviePosterPath,
                        title: movieTitle,
                        genre: getGenreName(movieGenreIds),
                        year: movieYear,
                        length: movieLength,
                        rating: movieRating,
                        description: movieDescription,
                        director: director,
                        actors: actors,
                        review: review,
                        tmdbLink: tmdbLink,
                        tolokaLink: tolokaLink,
                        rutrackerLink: rutrackerLink,
                        trailer: trailerLink,
                        id: movieId
                    };

                    if (!isDuplicateMovie(movieId)) {
                        saveMovieToLocalStorage(movieData);
                        displaySummary(movieData);
                        displayMoviesFromLocalStorage();
                    } else {
                        alert('This movie is already in your list.');
                    }
                } else {
                    alert('No movies found with that name.');
                }

                document.querySelector('#movieInput').value = ''; // Clear input after search
            } catch (error) {
                console.error('Error fetching movie data:', error);
            }
        }

        function isDuplicateMovie(movieId) {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            return movies.some(movie => movie.id === movieId);
        }

        function saveMovieToLocalStorage(movieData) {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            movies.push(movieData);
            localStorage.setItem('movies', JSON.stringify(movies));
        }

        function displayMoviesFromLocalStorage() {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const tbody = document.querySelector('#movieTable tbody');
            tbody.innerHTML = '';

            movies.forEach((movie, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><img src="${movie.poster}" alt="${movie.title} Poster" class="poster"></td>
                    <td>${movie.title}</td>
                    <td>${movie.genre}</td>
                    <td>${movie.year}</td>
                    <td>${movie.length}</td>
                    <td>${movie.rating}</td>
                    <td>${movie.description}</td>
                    <td>${movie.director}</td>
                    <td>${movie.actors}</td>
                    <td>${movie.review}</td>
                    <td><a href="${movie.tmdbLink}" target="_blank">TMDB</a></td>
                    <td><a href="${movie.tolokaLink}" target="_blank">Toloka</a></td>
                    <td><a href="${movie.rutrackerLink}" target="_blank">Rutracker</a></td>
                    <td><a href="${movie.trailer}" target="_blank">Trailer</a></td>
                    <td><button onclick="removeMovie(${movie.id})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });

            document.querySelector('#rowCount').innerText = `Total Movies: ${movies.length}`;
        }

        function displaySummary(movieData) {
            const summary = document.querySelector('#summary');
            summary.innerHTML = `
                <h3>Last Added Movie</h3>
                <img src="${movieData.poster}" alt="${movieData.title} Poster" class="poster">
                <p>Title: ${movieData.title}</p>
                <p>Genre: ${movieData.genre}</p>
                <p>Year: ${movieData.year}</p>
                <p>Length: ${movieData.length}</p>
                <p>Rating: ${movieData.rating}</p>
                <p>Description: ${movieData.description}</p>
                <p>Director: ${movieData.director}</p>
                <p>Actors: ${movieData.actors}</p>
                <p>Review: ${movieData.review}</p>
                <p>TMDB Link: <a href="${movieData.tmdbLink}" target="_blank">${movieData.tmdbLink}</a></p>
                <p>Toloka Link: <a href="${movieData.tolokaLink}" target="_blank">${movieData.tolokaLink}</a></p>
                <p>Rutracker Link: <a href="${movieData.rutrackerLink}" target="_blank">${movieData.rutrackerLink}</a></p>
                <p>Trailer: <a href="${movieData.trailer}" target="_blank">${movieData.trailer}</a></p>
            `;
        }

        function removeMovie(movieId) {
            let movies = JSON.parse(localStorage.getItem('movies')) || [];
            movies = movies.filter(movie => movie.id !== parseInt(movieId));
            localStorage.setItem('movies', JSON.stringify(movies));
            displayMoviesFromLocalStorage();
        }

        function removeAllMovies() {
            if (confirm('Are you sure you want to remove all movies?')) {
                localStorage.removeItem('movies');
                displayMoviesFromLocalStorage();
            }
        }

        function sortTable(columnIndex) {
            const table = document.querySelector('#movieTable');
            const rows = Array.from(table.querySelectorAll('tbody > tr'));
            const isAscending = table.querySelectorAll('th')[columnIndex].classList.contains('asc');

            rows.sort((rowA, rowB) => {
                const cellA = rowA.children[columnIndex].innerText.trim();
                const cellB = rowB.children[columnIndex].innerText.trim();
                return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });

            table.querySelector('tbody').append(...rows);
            table.querySelectorAll('th').forEach(th => th.classList.remove('asc', 'desc'));
            table.querySelectorAll('th')[columnIndex].classList.add(isAscending ? 'desc' : 'asc');
        }

        function exportMovies() {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const blob = new Blob([JSON.stringify(movies, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'movies.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportMoviesCSV() {
            const movies = JSON.parse(localStorage.getItem('movies')) || [];
            const csvRows = [
                ['Poster', 'Title', 'Genre', 'Year', 'Length', 'Rating', 'Description', 'Director', 'Actors', 'Review', 'TMDB Link', 'Toloka Link', 'Rutracker Link', 'Trailer']
            ];

            movies.forEach(movie => {
                const row = [
                    movie.poster,
                    movie.title,
                    movie.genre,
                    movie.year,
                    movie.length,
                    movie.rating,
                    movie.description,
                    movie.director,
                    movie.actors,
                    movie.review,
                    movie.tmdbLink,
                    movie.tolokaLink,
                    movie.rutrackerLink,
                    movie.trailer
                ];
                csvRows.push(row);
            });

            const csvString = csvRows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'movies.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importMoviesJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const importedMovies = JSON.parse(e.target.result);
                    let existingMovies = JSON.parse(localStorage.getItem('movies')) || [];

                    importedMovies.forEach(importedMovie => {
                        if (!existingMovies.some(movie => movie.id === importedMovie.id)) {
                            existingMovies.push(importedMovie);
                        }
                    });

                    localStorage.setItem('movies', JSON.stringify(existingMovies));
                    displayMoviesFromLocalStorage();
                };
                reader.readAsText(file);
            }
        }

        function importMoviesCSV(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvText = e.target.result;
                    const csvRows = csvText.trim().split('\n');
                    const headers = csvRows[0].split(',').map(header => header.trim().replace(/"/g, ''));
                    const movies = csvRows.slice(1).map(row => {
                        const cells = row.split(',').map(cell => cell.trim().replace(/"/g, ''));
                        return {
                            poster: cells[0],
                            title: cells[1],
                            genre: cells[2],
                            year: parseInt(cells[3]),
                            length: cells[4],
                            rating: parseFloat(cells[5]),
                            description: cells[6],
                            director: cells[7],
                            actors: cells[8],
                            review: cells[9],
                            tmdbLink: cells[10],
                            tolokaLink: cells[11],
                            rutrackerLink: cells[12],
                            trailer: cells[13],
                            id: parseInt(new URL(cells[10]).pathname.split('/')[2]) // Extract TMDB ID from the URL
                        };
                    });

                    let existingMovies = JSON.parse(localStorage.getItem('movies')) || [];

                    movies.forEach(importedMovie => {
                        if (!existingMovies.some(movie => movie.id === importedMovie.id)) {
                            existingMovies.push(importedMovie);
                        }
                    });

                    localStorage.setItem('movies', JSON.stringify(existingMovies));
                    displayMoviesFromLocalStorage();
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>
